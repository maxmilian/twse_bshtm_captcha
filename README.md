# 證交所買賣交易日報驗證碼

### 免責條款

此專案是個人學習如何使用 Deep Learning 中的 CNN，使用 Python 的 Keras、Tensorflow 進行實作，請勿使用於不法用途。若因使用該專案而侵害他人權利，請自行負責。

請參考 [證交所買賣日報](https://bsr.twse.com.tw/bshtm/use.htm) 使用條款

### 參考資料

其實基本上都是依照下面參考資料在實作，所以有疑問請在參考一下這些資料。

[如何透過OpenCV 破解台灣證券交易所買賣日報表的驗證碼(Captcha) (Part 1)?](https://www.youtube.com/watch?v=KESG8I9C3oA)

不過這專案主要是使用 Deep Learning 中的 CNN 影像辨識，而不是使用 pytesser 進行解碼。

### Dependencies

請先安裝相關的 python 套件

```sh
pip3 install -r requirements.txt
```

### 步驟

大致上分為四個步驟，以下會分步驟說明
- 爬蟲
- 預處理
- 標記圖片
- CNN深度學習

### 爬蟲

爬蟲請參考 `crawler.ipynb` 和編譯出來的 `crawler.py`。此程式使用 python requests 去抓取驗證碼存入至 captcha 目錄下。

檔案列表：

| # | ipython notebook 檔 | python檔 |
|---|---|---|
| 1 | crawler.ipynb |  |

### 預處理

圖片預處理就參考[參考資料](#參考資料)的 youtube 教學影片。另外在切割一下不需要的邊框，最後切成為 190 * 40 的圖片。

檔案列表：

| # | ipython notebook 檔 | python檔 |
|---|---|---|
| 1 | preprocess.ipynb |  |
| 2 | preprocess-batch.ipynb | preprocess-batch.py |

### 標記圖片

標記圖片花了很多時間，一開始使用我另外一個專案 [label_captcha_tool](https://github.com/maxmilian/label_captcha_tool) 進行標記。等到數量累積到一定量(>3000)後，並可以訓練並且使用爬蟲自動標記。自動標註請參考 `demo.ipynb`

這邊就標記檔，存成為 csv (`label.csv`)，每一個圖片一行，之後要丟入 CNN 當作 label 的訓練資料。

### CNN深度學習

CNN model 直接使用經典的VGG來改，不過為減小訓練時間，filters從32開始，並且加入了BatchNorm。

| # | ipython notebook 檔 | python檔 |
|---|---|---|
| 1 | cnn.ipynb | |

這邊就標記檔，存成為 csv，每一個圖片一行，之後要丟入 CNN 當作 label 的訓練資料。

model.summary()

```sh
Model: "model_1"
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to
==================================================================================================
input_1 (InputLayer)            (None, 40, 190, 3)   0
__________________________________________________________________________________________________
conv2d_1 (Conv2D)               (None, 40, 190, 32)  896         input_1[0][0]
__________________________________________________________________________________________________
conv2d_2 (Conv2D)               (None, 40, 190, 32)  9248        conv2d_1[0][0]
__________________________________________________________________________________________________
max_pooling2d_1 (MaxPooling2D)  (None, 20, 95, 32)   0           conv2d_2[0][0]
__________________________________________________________________________________________________
conv2d_3 (Conv2D)               (None, 20, 95, 64)   18496       max_pooling2d_1[0][0]
__________________________________________________________________________________________________
conv2d_4 (Conv2D)               (None, 20, 95, 64)   36928       conv2d_3[0][0]
__________________________________________________________________________________________________
max_pooling2d_2 (MaxPooling2D)  (None, 10, 47, 64)   0           conv2d_4[0][0]
__________________________________________________________________________________________________
conv2d_5 (Conv2D)               (None, 10, 47, 128)  73856       max_pooling2d_2[0][0]
__________________________________________________________________________________________________
conv2d_6 (Conv2D)               (None, 10, 47, 128)  147584      conv2d_5[0][0]
__________________________________________________________________________________________________
batch_normalization_1 (BatchNor (None, 10, 47, 128)  40          conv2d_6[0][0]
__________________________________________________________________________________________________
max_pooling2d_3 (MaxPooling2D)  (None, 5, 23, 128)   0           batch_normalization_1[0][0]
__________________________________________________________________________________________________
conv2d_7 (Conv2D)               (None, 5, 23, 256)   295168      max_pooling2d_3[0][0]
__________________________________________________________________________________________________
conv2d_8 (Conv2D)               (None, 5, 23, 256)   590080      conv2d_7[0][0]
__________________________________________________________________________________________________
max_pooling2d_4 (MaxPooling2D)  (None, 2, 11, 256)   0           conv2d_8[0][0]
__________________________________________________________________________________________________
conv2d_9 (Conv2D)               (None, 2, 11, 512)   1180160     max_pooling2d_4[0][0]
__________________________________________________________________________________________________
batch_normalization_2 (BatchNor (None, 2, 11, 512)   8           conv2d_9[0][0]
__________________________________________________________________________________________________
max_pooling2d_5 (MaxPooling2D)  (None, 1, 5, 512)    0           batch_normalization_2[0][0]
__________________________________________________________________________________________________
flatten_1 (Flatten)             (None, 2560)         0           max_pooling2d_5[0][0]
__________________________________________________________________________________________________
dropout_1 (Dropout)             (None, 2560)         0           flatten_1[0][0]
__________________________________________________________________________________________________
digit1 (Dense)                  (None, 27)           69147       dropout_1[0][0]
__________________________________________________________________________________________________
digit2 (Dense)                  (None, 27)           69147       dropout_1[0][0]
__________________________________________________________________________________________________
digit3 (Dense)                  (None, 27)           69147       dropout_1[0][0]
__________________________________________________________________________________________________
digit4 (Dense)                  (None, 27)           69147       dropout_1[0][0]
__________________________________________________________________________________________________
digit5 (Dense)                  (None, 27)           69147       dropout_1[0][0]
==================================================================================================
Total params: 2,698,199
Trainable params: 2,698,175
Non-trainable params: 24
__________________________________________________________________________________________________
```

model.fit log

#### 訓練 log

### 其他

```
# 影像預處理
jupyter nbconvert --to script preprocessBatch.ipynb

# utilties
jupyter nbconvert --to script utilities.ipynb
```

### 協作

此專案由 Max Hsu <maxmilian@gmail.com> 完成，

歡迎協作，請使用 GitHub issue 以及 Pull Request 功能來協作。
